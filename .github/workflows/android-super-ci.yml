name: ğŸš€ Android Super CI - Complete Cloud Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  JAVA_VERSION: 17
  GRADLE_VERSION: 8.2
  ANDROID_COMPILE_SDK: 34
  ANDROID_BUILD_TOOLS_VERSION: 34.0.0

jobs:
  # Job 1: Build APK
  build-apk:
    name: ğŸ—ï¸ Build APK
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: â˜• Set Up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'zulu'
        
    - name: ğŸ”„ Cache Gradle Packages
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: ğŸ” Grant Execute Permission for Gradlew
      run: |
        chmod +x gradlew
        chmod +x gradlew.bat
        
    - name: ğŸ§ª Validate Gradle Wrapper
      run: ./gradlew wrapper --gradle-version ${{ env.GRADLE_VERSION }}
      
    - name: ğŸ—ï¸ Build Debug APK
      run: ./gradlew assembleDebug
      env:
        ANDROID_COMPILE_SDK: ${{ env.ANDROID_COMPILE_SDK }}
        ANDROID_BUILD_TOOLS_VERSION: ${{ env.ANDROID_BUILD_TOOLS_VERSION }}
        
    - name: ğŸ“¦ Upload APK Artifact
      uses: actions/upload-artifact@v3
      with:
        name: debug-apk
        path: app/build/outputs/apk/debug/app-debug.apk
        retention-days: 30
        
    - name: ğŸ“„ Upload Build Info
      run: |
        echo "Build completed at $(date)" > build-info.txt
        echo "Commit: ${{ github.sha }}" >> build-info.txt
        echo "Branch: ${{ github.ref }}" >> build-info.txt
        echo "Repository: ${{ github.repository }}" >> build-info.txt
        
    - name: ğŸ“‹ Archive Build Info
      uses: actions/upload-artifact@v3
      with:
        name: build-info
        path: build-info.txt
        retention-days: 30

  # Job 2: Firebase Test Lab Multi-Device Testing
  firebase-test-lab:
    name: ğŸ§ª Firebase Test Lab
    runs-on: ubuntu-latest
    needs: build-apk
    if: success()
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ“¥ Download APK
      uses: actions/download-artifact@v3
      with:
        name: debug-apk
        path: ./
        
    - name: â˜• Set Up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'zulu'
        
    - name: ğŸ”§ Setup Google Cloud SDK
      run: |
        sudo apt-get update && sudo apt-get install -y \
          apt-transport-https ca-certificates gnupg curl
        
        echo "deb [signed-by=/etc/apt/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | \
          sudo tee -a /etc/apt/sources.list.d/google-cloud-sdk.list
        
        curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | \
          sudo apt-key --keyring /etc/apt/keyrings/cloud.google.gpg add -
        
        sudo apt-get update && sudo apt-get install -y google-cloud-cli
        echo "gcloud version:" && gcloud --version
        
    - name: ğŸ” Authenticate with Google Cloud
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: ${{ secrets.GOOGLE_WORKLOAD_IDENTITY_PROVIDER }}
        service_account: ${{ secrets.GOOGLE_SERVICE_ACCOUNT }}
        
    - name: ğŸ”§ Initialize Google Cloud
      run: |
        gcloud auth list
        gcloud config set project ${{ secrets.GOOGLE_CLOUD_PROJECT }}
        gcloud services enable firebase.googleapis.com
        gcloud services enable firebase.testlab.googleapis.com
        
    - name: ğŸ” Check APK File
      run: |
        ls -la *.apk || echo "No APK found"
        file *.apk || echo "No APK file to check"
        
    - name: ğŸ“± Test on Multiple Devices - Device Matrix
      run: |
        echo "Starting Firebase Test Lab with device matrix..."
        
        # Multi-device testing matrix for comprehensive coverage
        gcloud firebase test android run \
          --type robo \
          --app app-debug.apk \
          --device model=Pixel4,version=30,locale=en,orientation=portrait \
          --device model=Pixel5,version=29,locale=en,orientation=portrait \
          --device model=GalaxyS10,version=28,locale=en,orientation=portrait \
          --device model=MediumPhone,version=30,locale=en,orientation=portrait \
          --device model=LowEndPhone,version=26,locale=en,orientation=portrait \
          --timeout 180s \
          --results-dir test-results \
          --results-bucket-location=us-central1 \
          --format="table(id,outcomeMatrix,executionId)" \
          --enable-performance-metrics \
          --enable-network-info
          
    - name: ğŸ“Š Download Test Results
      run: |
        echo "Downloading Firebase Test Lab results..."
        
        # List all test result buckets
        gsutil ls gs://test-lab-* || echo "No test result buckets found"
        
        # Try to download from all possible result buckets
        for bucket in $(gsutil ls gs://test-lab-* 2>/dev/null || true); do
          echo "Downloading from bucket: $bucket"
          gsutil -m cp -r "${bucket}test-results" ./test-results/ 2>/dev/null || true
        done
        
        # Show what we downloaded
        if [ -d "./test-results" ]; then
          echo "Test results directory contents:"
          find ./test-results -type f | head -20
          
          echo "Looking for log files:"
          find ./test-results -name "*.log" -o -name "*.xml" -o -name "*.json" | head -10
        else
          echo "No test results directory found"
        fi
        
    - name: ğŸ” Parse Crash Logs and Generate Report
      run: |
        echo "=== FIREBASE TEST LAB ANALYSIS ==="
        echo "Timestamp: $(date)"
        echo "Repository: ${{ github.repository }}"
        echo "Commit: ${{ github.sha }}"
        echo ""
        
        # Check for crash logs in various formats
        echo "ğŸ” Searching for crash information..."
        
        # Search for FATAL EXCEPTION patterns
        if [ -d "./test-results" ]; then
          echo "Searching test results for crash information:"
          find ./test-results -name "*.log" -exec grep -l "FATAL\|AndroidRuntime\|Crashed" {} \; 2>/dev/null || echo "No crash logs found"
          
          echo ""
          echo "ğŸ“± Device Test Matrix Results:"
          
          # Parse any test result files for pass/fail
          find ./test-results -name "*.xml" -o -name "*.json" | while read file; do
            echo "File: $file"
            if grep -q "test-case" "$file" 2>/dev/null; then
              echo "  - Contains test cases"
            fi
            if grep -q "success\|passed" "$file" 2>/dev/null; then
              echo "  - âœ… Contains successful tests"
            fi
            if grep -q "failed\|error" "$file" 2>/dev/null; then
              echo "  - âŒ Contains failed tests"
            fi
          done
        fi
        
        # Generate crash summary
        echo ""
        echo "ğŸš¨ CRASH ANALYSIS SUMMARY:"
        if [ -d "./test-results" ]; then
          CRASH_COUNT=$(find ./test-results -name "*.log" -exec grep -c "FATAL\|AndroidRuntime.*Process:" {} \; 2>/dev/null | awk '{sum += $1} END {print sum+0}')
          echo "Total FATAL exceptions found: $CRASH_COUNT"
          
          if [ "$CRASH_COUNT" -gt 0 ]; then
            echo "âš ï¸  CRASHES DETECTED! Check detailed logs above."
            find ./test-results -name "*.log" -exec grep -H "FATAL\|AndroidRuntime.*Process:" {} \;
          else
            echo "âœ… NO CRASHES DETECTED - All tests passed without FATAL exceptions"
          fi
        else
          echo "â„¹ï¸  No test results available for crash analysis"
        fi
        
    - name: ğŸ“ Upload Test Results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-results
        path: test-results/
        retention-days: 30
        
    - name: ğŸ“ Generate Test Summary
      run: |
        echo "# Firebase Test Lab Summary Report" > test-summary.md
        echo "" >> test-summary.md
        echo "**Repository:** ${{ github.repository }}" >> test-summary.md
        echo "**Commit:** ${{ github.sha }}" >> test-summary.md
        echo "**Build Time:** $(date)" >> test-summary.md
        echo "**Workflow:** ${{ github.workflow }}" >> test-summary.md
        echo "" >> test-summary.md
        
        echo "## Test Results" >> test-summary.md
        
        if [ -d "./test-results" ]; then
          echo "âœ… Test results downloaded successfully" >> test-summary.md
          echo "- Device tests completed on Firebase Test Lab" >> test-summary.md
          echo "- Multi-device matrix: Pixel 4, 5, Galaxy S10, MediumPhone, LowEndPhone" >> test-summary.md
          echo "- All devices tested on Android API 26, 28, 29, 30" >> test-summary.md
        else
          echo "â„¹ï¸  Test results directory not available" >> test-summary.md
        fi
        
        echo "" >> test-summary.md
        echo "## APK Download" >> test-summary.md
        echo "Your built APK is available in the 'debug-apk' artifact." >> test-summary.md
        echo "Download from GitHub Actions â†’ Artifacts â†’ debug-apk" >> test-summary.md
        
        echo "" >> test-summary.md
        echo "## Next Steps" >> test-summary.md
        echo "1. Download and test the APK on your device" >> test-summary.md
        echo "2. Check Firebase Console for detailed test results" >> test-summary.md
        echo "3. Monitor crash reports in Firebase Crashlytics" >> test-summary.md
        
    - name: ğŸ“‹ Archive Test Summary
      uses: actions/upload-artifact@v3
      with:
        name: test-summary
        path: test-summary.md
        retention-days: 30

  # Job 3: Final Status
  final-status:
    name: ğŸ¯ Final Status
    runs-on: ubuntu-latest
    needs: [build-apk, firebase-test-lab]
    if: always()
    
    steps:
    - name: ğŸ“Š Build Final Report
      run: |
        echo "=== ANDROID SUPER CI PIPELINE COMPLETE ==="
        echo ""
        echo "Build Status: ${{ needs.build-apk.result }}"
        echo "Test Status: ${{ needs.firebase-test-lab.result }}"
        echo ""
        
        if [ "${{ needs.build-apk.result }}" = "success" ]; then
          echo "âœ… APK BUILD: SUCCESS"
          echo "   - Debug APK built and uploaded as artifact"
          echo "   - Available in GitHub Actions â†’ Artifacts â†’ debug-apk"
        else
          echo "âŒ APK BUILD: FAILED"
        fi
        
        if [ "${{ needs.firebase-test-lab.result }}" = "success" ]; then
          echo "âœ… FIREBASE TESTING: SUCCESS"
          echo "   - Multi-device testing completed"
          echo "   - Test results and logs uploaded"
          echo "   - Check artifacts for detailed results"
        else
          echo "âŒ FIREBASE TESTING: FAILED"
        fi
        
        echo ""
        echo "ğŸ“± DOWNLOAD APK:"
        echo "GitHub Actions â†’ Workflow run â†’ Artifacts â†’ debug-apk"
        echo ""
        echo "ğŸ“‹ VIEW TEST RESULTS:"
        echo "Download test-results artifact for detailed logs and crash analysis"
        echo ""
        echo "ğŸ”¥ CRASHLYTICS STATUS:"
        echo "Ready to activate - add real google-services.json file"
        echo ""
        echo "ğŸš€ CLOUD CI/CD: 100% AUTOMATED AND ACTIVE"

    - name: ğŸ“¢ Slack Notification (Optional)
      if: always()
      run: |
        if [ "${{ needs.build-apk.result }}" = "success" ] && [ "${{ needs.firebase-test-lab.result }}" = "success" ]; then
          echo "âœ… Android pipeline completed successfully"
        else
          echo "âŒ Android pipeline failed - check logs above"
        fi