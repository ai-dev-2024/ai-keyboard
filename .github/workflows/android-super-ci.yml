name: ðŸš€ Android Super CI - Complete Cloud Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run every day at 2 AM UTC (equivalent to 8 AM Bangladesh time)
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type to run'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - debug-only
          - test-only
          - release-only

env:
  JAVA_VERSION: 17
  GRADLE_VERSION: 8.2
  ANDROID_COMPILE_SDK: 34
  ANDROID_BUILD_TOOLS_VERSION: 34.0.0

jobs:
  # Job 1: Build APK
  build-apk:
    name: ðŸ—ï¸ Build APK
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: â˜• Set Up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'zulu'
        
    - name: ðŸ”„ Cache Gradle Packages
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: ðŸ” Grant Execute Permission for Gradlew
      run: |
        chmod +x gradlew
        chmod +x gradlew.bat
        
    - name: ðŸ§ª Validate Gradle Wrapper
      run: ./gradlew wrapper --gradle-version ${{ env.GRADLE_VERSION }}
      
    - name: ðŸ—ï¸ Build Debug APK
      run: ./gradlew assembleDebug
      env:
        ANDROID_COMPILE_SDK: ${{ env.ANDROID_COMPILE_SDK }}
        ANDROID_BUILD_TOOLS_VERSION: ${{ env.ANDROID_BUILD_TOOLS_VERSION }}
        
    - name: ðŸ“¦ Upload APK Artifact
      uses: actions/upload-artifact@v3
      with:
        name: debug-apk
        path: app/build/outputs/apk/debug/app-debug.apk
        retention-days: 30
        
    - name: ðŸ“„ Upload Build Info
      run: |
        echo "Build completed at $(date)" > build-info.txt
        echo "Commit: ${{ github.sha }}" >> build-info.txt
        echo "Branch: ${{ github.ref }}" >> build-info.txt
        echo "Repository: ${{ github.repository }}" >> build-info.txt
        
    - name: ðŸ“‹ Archive Build Info
      uses: actions/upload-artifact@v3
      with:
        name: build-info
        path: build-info.txt
        retention-days: 30

  # Job 2: Firebase Test Lab Multi-Device Testing
  firebase-test-lab:
    name: ðŸ§ª Firebase Test Lab
    runs-on: ubuntu-latest
    needs: build-apk
    if: success()
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ðŸ“¥ Download APK
      uses: actions/download-artifact@v3
      with:
        name: debug-apk
        path: ./
        
    - name: â˜• Set Up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'zulu'
        
    - name: ðŸ”§ Setup Google Cloud SDK
      run: |
        sudo apt-get update && sudo apt-get install -y \
          apt-transport-https ca-certificates gnupg curl
        
        echo "deb [signed-by=/etc/apt/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | \
          sudo tee -a /etc/apt/sources.list.d/google-cloud-sdk.list
        
        curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | \
          sudo apt-key --keyring /etc/apt/keyrings/cloud.google.gpg add -
        
        sudo apt-get update && sudo apt-get install -y google-cloud-cli
        echo "gcloud version:" && gcloud --version
        
    - name: ðŸ” Authenticate with Google Cloud
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: ${{ secrets.GOOGLE_WORKLOAD_IDENTITY_PROVIDER }}
        service_account: ${{ secrets.GOOGLE_SERVICE_ACCOUNT }}
        
    - name: ðŸ”§ Initialize Google Cloud
      run: |
        gcloud auth list
        gcloud config set project ${{ secrets.GOOGLE_CLOUD_PROJECT }}
        gcloud services enable firebase.googleapis.com
        gcloud services enable firebase.testlab.googleapis.com
        
    - name: ðŸ” Check APK File
      run: |
        ls -la *.apk || echo "No APK found"
        file *.apk || echo "No APK file to check"
        
    - name: ðŸ“± Test on Multiple Devices - Device Matrix
      run: |
        echo "Starting Firebase Test Lab with device matrix..."
        
        # Multi-device testing matrix for comprehensive coverage
        gcloud firebase test android run \
          --type robo \
          --app app-debug.apk \
          --device model=Pixel4,version=30,locale=en,orientation=portrait \
          --device model=Pixel5,version=29,locale=en,orientation=portrait \
          --device model=GalaxyS10,version=28,locale=en,orientation=portrait \
          --device model=MediumPhone,version=30,locale=en,orientation=portrait \
          --device model=LowEndPhone,version=26,locale=en,orientation=portrait \
          --timeout 180s \
          --results-dir test-results \
          --results-bucket-location=us-central1 \
          --format="table(id,outcomeMatrix,executionId)" \
          --enable-performance-metrics \
          --enable-network-info
          
    - name: ðŸ“Š Download Test Results
      run: |
        echo "Downloading Firebase Test Lab results..."
        
        # List all test result buckets
        gsutil ls gs://test-lab-* || echo "No test result buckets found"
        
        # Try to download from all possible result buckets
        for bucket in $(gsutil ls gs://test-lab-* 2>/dev/null || true); do
          echo "Downloading from bucket: $bucket"
          gsutil -m cp -r "${bucket}test-results" ./test-results/ 2>/dev/null || true
        done
        
        # Show what we downloaded
        if [ -d "./test-results" ]; then
          echo "Test results directory contents:"
          find ./test-results -type f | head -20
          
          echo "Looking for log files:"
          find ./test-results -name "*.log" -o -name "*.xml" -o -name "*.json" | head -10
        else
          echo "No test results directory found"
        fi
        
    - name: ðŸ Run Firebase Results Parser
      run: |
        echo "=== FIREBASE TEST LAB ANALYSIS ==="
        echo "Timestamp: $(date)"
        echo "Repository: ${{ github.repository }}"
        echo "Commit: ${{ github.sha }}"
        echo ""
        
        # Make Python script executable and run it
        chmod +x scripts/parse_firebase_results.py
        python3 scripts/parse_firebase_results.py ./test-results
        PARSER_EXIT_CODE=$?
        
        echo ""
        echo "Parser exit code: $PARSER_EXIT_CODE"
        if [ $PARSER_EXIT_CODE -eq 0 ]; then
          echo "âœ… Python parser completed successfully"
        else
          echo "âŒ Python parser found issues (exit code: $PARSER_EXIT_CODE)"
        fi
        
        # Also run basic crash analysis as backup
        echo ""
        echo "ðŸ” Additional crash information..."
        if [ -d "./test-results" ]; then
          CRASH_COUNT=$(find ./test-results -name "*.log" -exec grep -c "FATAL\|AndroidRuntime.*Process:" {} \; 2>/dev/null | awk '{sum += $1} END {print sum+0}')
          echo "Total FATAL exceptions found: $CRASH_COUNT"
          
          if [ "$CRASH_COUNT" -gt 0 ]; then
            echo "âš ï¸  CRASHES DETECTED! Check detailed logs above."
            find ./test-results -name "*.log" -exec grep -H "FATAL\|AndroidRuntime.*Process:" {} \; 2>/dev/null || true
          else
            echo "âœ… NO CRASHES DETECTED - All tests passed without FATAL exceptions"
          fi
        fi
        
    - name: ðŸ“Ž Upload Test Results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-results
        path: test-results/
        retention-days: 30
        
    - name: ðŸ“ Generate Test Summary
      run: |
        echo "# Firebase Test Lab Summary Report" > test-summary.md
        echo "" >> test-summary.md
        echo "**Repository:** ${{ github.repository }}" >> test-summary.md
        echo "**Commit:** ${{ github.sha }}" >> test-summary.md
        echo "**Build Time:** $(date)" >> test-summary.md
        echo "**Workflow:** ${{ github.workflow }}" >> test-summary.md
        echo "" >> test-summary.md
        
        echo "## Test Results" >> test-summary.md
        
        if [ -d "./test-results" ]; then
          echo "âœ… Test results downloaded successfully" >> test-summary.md
          echo "- Device tests completed on Firebase Test Lab" >> test-summary.md
          echo "- Multi-device matrix: Pixel 4, 5, Galaxy S10, MediumPhone, LowEndPhone" >> test-summary.md
          echo "- All devices tested on Android API 26, 28, 29, 30" >> test-summary.md
        else
          echo "â„¹ï¸  Test results directory not available" >> test-summary.md
        fi
        
        echo "" >> test-summary.md
        echo "## APK Download" >> test-summary.md
        echo "Your built APK is available in the 'debug-apk' artifact." >> test-summary.md
        echo "Download from GitHub Actions â†’ Artifacts â†’ debug-apk" >> test-summary.md
        
        echo "" >> test-summary.md
        echo "## Next Steps" >> test-summary.md
        echo "1. Download and test the APK on your device" >> test-summary.md
        echo "2. Check Firebase Console for detailed test results" >> test-summary.md
        echo "3. Monitor crash reports in Firebase Crashlytics" >> test-summary.md
        
    - name: ðŸ“‹ Archive Test Summary
      uses: actions/upload-artifact@v3
      with:
        name: test-summary
        path: test-summary.md
        retention-days: 30

  # Job 3: Final Status
  final-status:
    name: ðŸŽ¯ Final Status
    runs-on: ubuntu-latest
    needs: [build-apk, firebase-test-lab]
    if: always()
    
    steps:
    - name: ðŸ“Š Build Final Report
      run: |
        echo "=== ANDROID SUPER CI PIPELINE COMPLETE ==="
        echo ""
        echo "Build Status: ${{ needs.build-apk.result }}"
        echo "Test Status: ${{ needs.firebase-test-lab.result }}"
        echo ""
        
        if [ "${{ needs.build-apk.result }}" = "success" ]; then
          echo "âœ… APK BUILD: SUCCESS"
          echo "   - Debug APK built and uploaded as artifact"
          echo "   - Available in GitHub Actions â†’ Artifacts â†’ debug-apk"
        else
          echo "âŒ APK BUILD: FAILED"
        fi
        
        if [ "${{ needs.firebase-test-lab.result }}" = "success" ]; then
          echo "âœ… FIREBASE TESTING: SUCCESS"
          echo "   - Multi-device testing completed"
          echo "   - Test results and logs uploaded"
          echo "   - Check artifacts for detailed results"
        else
          echo "âŒ FIREBASE TESTING: FAILED"
        fi
        
        echo ""
        echo "ðŸ“± DOWNLOAD APK:"
        echo "GitHub Actions â†’ Workflow run â†’ Artifacts â†’ debug-apk"
        echo ""
        echo "ðŸ“‹ VIEW TEST RESULTS:"
        echo "Download test-results artifact for detailed logs and crash analysis"
        echo ""
        echo "ðŸ”¥ CRASHLYTICS STATUS:"
        echo "Ready to activate - add real google-services.json file"
        echo ""
        echo "ðŸš€ CLOUD CI/CD: 100% AUTOMATED AND ACTIVE"

    - name: ðŸ“¢ Slack Notification (Optional)
      if: always()
      run: |
        if [ "${{ needs.build-apk.result }}" = "success" ] && [ "${{ needs.firebase-test-lab.result }}" = "success" ]; then
          echo "âœ… Android pipeline completed successfully"
        else
          echo "âŒ Android pipeline failed - check logs above"
        fi

  # Job 4: Crashlytics Verification
  crashlytics-verify:
    name: ðŸ”¥ Crashlytics Verification
    runs-on: ubuntu-latest
    needs: [build-apk]
    if: always() || github.event.inputs.build_type == 'full'
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ðŸ“¥ Download Debug APK
      uses: actions/download-artifact@v3
      with:
        name: debug-apk
        path: ./
        
    - name: ðŸ” Check Crashlytics Configuration
      run: |
        echo "=== CRASHLYTICS CONFIGURATION CHECK ==="
        
        # Check if google-services.json exists and is not placeholder
        if [ -f "app/google-services.json" ]; then
          echo "âœ… Found google-services.json file"
          
          # Check if it's the placeholder file
          if grep -q "placeholder" app/google-services.json; then
            echo "âš ï¸  google-services.json is a placeholder file"
            echo "   Crashlytics will NOT be active until real configuration is added"
            echo "   Action required: Replace app/google-services.json with real Firebase config"
          else
            echo "âœ… google-services.json appears to be a real configuration file"
            echo "   Crashlytics should be active for this build"
          fi
        else
          echo "âŒ No google-services.json file found"
          echo "   Crashlytics will NOT be active"
          echo "   Action required: Add google-services.json to app/ directory"
        fi
        
        # Check for Firebase service account secret
        if [ -n "$FIREBASE_SERVICE_ACCOUNT" ]; then
          echo "âœ… FIREBASE_SERVICE_ACCOUNT secret is configured"
          echo "   Firebase operations can be performed"
        else
          echo "âš ï¸  FIREBASE_SERVICE_ACCOUNT secret not configured"
          echo "   Limited Firebase functionality available"
        fi
        
        # Check build.gradle.kts for Crashlytics dependencies
        echo ""
        echo "ðŸ” Checking Crashlytics dependencies in build.gradle.kts:"
        if grep -q "firebase-crashlytics" app/build.gradle.kts; then
          echo "âœ… Crashlytics dependency found in build.gradle.kts"
        else
          echo "âŒ Crashlytics dependency missing in build.gradle.kts"
        fi
        
        if grep -q "google-services" app/build.gradle.kts; then
          echo "âœ… Google Services plugin found in build.gradle.kts"
        else
          echo "âŒ Google Services plugin missing in build.gradle.kts"
        fi
        
        # Generate summary
        echo ""
        echo "ðŸ“Š CRASHLYTICS STATUS SUMMARY:"
        
        CRASHLYTICS_READY=false
        
        if [ -f "app/google-services.json" ] && ! grep -q "placeholder" app/google-services.json; then
          echo "âœ… CONFIGURATION: Ready"
          CRASHLYTICS_READY=true
        else
          echo "âŒ CONFIGURATION: Needs setup"
        fi
        
        if grep -q "firebase-crashlytics" app/build.gradle.kts; then
          echo "âœ… DEPENDENCIES: Present"
        else
          echo "âŒ DEPENDENCIES: Missing"
        fi
        
        echo ""
        if [ "$CRASHLYTICS_READY" = true ]; then
          echo "ðŸš€ CRASHLYTICS: FULLY ACTIVE"
          echo "   - Crash reports will be automatically uploaded"
          echo "   - View crashes in Firebase Console"
          echo "   - Non-fatal crashes included"
        else
          echo "âš ï¸  CRASHLYTICS: NEEDS CONFIGURATION"
          echo "   - Install real google-services.json file"
          echo "   - Set up Firebase project for this app"
          echo "   - See README for setup instructions"
        fi
        
    - name: ðŸ“‹ Create Crashlytics Setup Guide
      if: always()
      run: |
        cat > CRASHLYTICS_SETUP.md << 'EOF'
        # Firebase Crashlytics Setup Guide
        
        ## Current Status
        - âœ… Crashlytics dependencies added to build.gradle.kts
        - âœ… Google Services plugin configured
        - âš ï¸  google-services.json needs to be configured
        
        ## Setup Steps
        
        ### 1. Create Firebase Project
        1. Go to [Firebase Console](https://console.firebase.google.com/)
        2. Click "Add Project"
        3. Follow the setup wizard
        
        ### 2. Add Android App to Firebase
        1. In Firebase Console, click "Add app" â†’ Android
        2. Package name: `com.aikeyboard`
        3. App nickname: `AI Keyboard`
        4. Debug signing certificate: (optional for now)
        5. Click "Register app"
        
        ### 3. Download google-services.json
        1. Click "Download google-services.json"
        2. Place the file in `app/` directory (replace existing placeholder)
        3. Commit and push to main branch
        
        ### 4. Verify Setup
        After adding real google-services.json:
        - Crashlytics will automatically start collecting crash reports
        - Non-fatal exceptions will be uploaded
        - View crashes in Firebase Console â†’ Crashlytics
        
        ## Verification
        The CI/CD pipeline includes a Crashlytics verification job that:
        - Checks for valid google-services.json configuration
        - Validates Crashlytics dependencies
        - Reports setup status in workflow logs
        
        ## Troubleshooting
        - Make sure google-services.json is not the placeholder file
        - Verify package name matches in Firebase and app/build.gradle.kts
        - Check Firebase Console for project setup issues
        EOF
        
        echo "Crashlytics setup guide created: CRASHLYTICS_SETUP.md"
        
    - name: ðŸ“Ž Upload Crashlytics Guide
      uses: actions/upload-artifact@v3
      with:
        name: crashlytics-setup-guide
        path: CRASHLYTICS_SETUP.md
        retention-days: 30