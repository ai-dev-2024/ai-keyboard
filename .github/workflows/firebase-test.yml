name: Firebase Test Lab

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'zulu'
        
    - name: Cache Gradle packages
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      
    - name: Build with Gradle
      run: ./gradlew assembleDebug
      
    - name: Upload APK
      uses: actions/upload-artifact@v3
      with:
        name: app-debug
        path: app/build/outputs/apk/debug/app-debug.apk
        
    - name: Set up Google Cloud SDK
      run: |
        sudo apt-get update
        sudo apt-get install -y apt-transport-https ca-certificates gnupg curl
        echo "deb [signed-by=/etc/apt/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | sudo tee -a /etc/apt/sources.list.d/google-cloud-sdk.list
        curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key --keyring /etc/apt/keyrings/cloud.google.gpg add -
        sudo apt-get update && sudo apt-get install -y google-cloud-cli
        
    - name: Authenticate with Google Cloud
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: ${{ secrets.GOOGLE_WORKLOAD_IDENTITY_PROVIDER }}
        service_account: ${{ secrets.GOOGLE_SERVICE_ACCOUNT }}
        
    - name: Initialize Firebase
      run: firebase use --add
      
    - name: Run Firebase Test Lab
      run: |
        gcloud firebase test android run \
          --type robo \
          --app app/build/outputs/apk/debug/app-debug.apk \
          --device model=Pixel5,version=30 \
          --device model=Pixel4,version=29 \
          --device model=GalaxyS10,version=28 \
          --timeout 300s \
          --results-dir test-results \
          --results-bucket-location=us-central1 \
          --format="table(id, outcomeMatrix, executionId)"
          
    - name: Download Test Results
      run: |
        gsutil -m cp -r gs://test-lab-*/test-results ./test-results/ || echo "No results to download"
        if [ -d "./test-results" ]; then
          echo "Test results downloaded:"
          find ./test-results -type f -name "*.xml" -o -name "*.json" | head -10
        else
          echo "No test results directory found"
        fi
        
    - name: Print Test Summary
      run: |
        echo "=== Firebase Test Lab Summary ==="
        echo "Test execution completed!"
        echo "Check the Firebase console for detailed results:"
        echo "https://console.firebase.google.com/project/_/testlab/histories"
        echo ""
        echo "Build Status: ✅ SUCCESS"
        echo "Cloud Testing: ✅ ACTIVE"
        echo "No emulator required!"